{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "ElasticSearch Template",
  "Parameters" : {
    "DomainName" : {
      "Type" : "String",
      "Description" : "Domain name for the ElasticSearch instance"
    },
    "ESInstanceType" : {
      "Description" : "WebServer EC2 instance type",
      "Type" : "String",
      "Default" : "m3.medium.elasticsearch"
    },
    "ESPublisherLambdaS3Bucket" : {
      "Type" : "String"
    },
    "ESPublisherLambdaS3Object" : {
      "Type" : "String"
    },
    "KinesisShardCount" : {
      "Type" : "Number"
    }
  },
  "Resources" : {
    "Kinesis" : {
     "Type" : "AWS::Kinesis::Stream",
     "Properties" : {
        "ShardCount" : { "Ref" : "KinesisShardCount" }
      }
    },
    "ElasticSearch" : {
      "Type" : "AWS::Elasticsearch::Domain",
      "Properties" : {
        "DomainName" : { "Ref" : "DomainName" }
      }
    },
    "CloudWatchKinesisRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/logging/",
        "AssumeRolePolicyDocument" : {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "logs.us-west-2.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        }
      }
    },
    "ESPublisherLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties":{
        "Path": "/logging/",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "lambda.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "ESPublisherPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "es:*"
                  ],
                  "Resource":  { "Fn::GetAtt" : [ "ElasticSearch", "DomainArn" ] }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "arn:aws:logs:*:*:*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kinesis:DescribeStream",
                    "kinesis:ListStreams",
                    "kinesis:GetShardIterator",
                    "kinesis:GetRecords"
                  ],
                  "Resource": [
                    { "Fn::GetAtt" : [ "Kinesis", "Arn" ] }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "ESPublisherLambda" : {
      "Type" : "AWS::Lambda::Function",
      "Properties" : {
        "Code" : {
          "S3Bucket": { "Ref" : "ESPublisherLambdaS3Bucket" },
          "S3Key": {"Ref": "ESPublisherLambdaS3Object" }
        },
        "Description" : "Tool for publishing Kinesis logs to ElasticSearch.",
        "Handler" : "es_publisher.handler",
        "Role" : { "Fn::GetAtt": [ "ESPublisherLambdaRole", "Arn" ] },
        "Runtime" : "python2.7",
        "Timeout" : "100"
      }
    },
    "ESPublisherEventSourceMapping" : {
      "Type" : "AWS::Lambda::EventSourceMapping",
      "Properties" : {
        "BatchSize" : 1,
        "Enabled" : "true",
        "EventSourceArn" : { "Fn::GetAtt" : [ "Kinesis", "Arn" ] },
        "FunctionName" : { "Fn::GetAtt" : [ "ESPublisherLambda", "Arn" ] },
        "StartingPosition" : "LATEST"
      }
    }
  },
  "Outputs" : {
    "CWKinesisRoleARN" : {
      "Value": {
        "Fn::GetAtt" : [ "CloudWatchKinesisRole", "Arn" ]
      }
    },
    "CWKinesisRoleName" : {
      "Value" : { "Ref" : "CloudWatchKinesisRole" }
    }
  }
}
